name: Deploy Next.js with Docker

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker build and Push
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/meetfolio-web:latest .
          docker push ${{secrets.DOCKER_USERNAME}}/meetfolio-web:latest

      - name: Set ENV
        env:
          NEXT_PUBLIC_SERVER: ${{ secrets.NEXT_PUBLIC_SERVER }}
          NEXT_PUBLIC_NEXT_SERVER: ${{ secrets.NEXT_PUBLIC_NEXT_SERVER }}
        run: |
          echo "NEXT_PUBLIC_SERVER=$NEXT_PUBLIC_SERVER" > myfile
          echo "NEXT_PUBLIC_NEXT_SERVER=$NEXT_PUBLIC_NEXT_SERVER" >> myfile
          cat myfile

      - name: Deploy in GCP
        uses: appleboy/ssh-action@master
        env:
          ENVFILE: "/home/meetfolio4/.env.local"
        with:
          host: ${{ secrets.GCE_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            rm -rf .env.local
            echo "NEXT_PUBLIC_SERVER=${{ secrets.NEXT_PUBLIC_SERVER }}" > .env.local
            echo "NEXT_PUBLIC_NEXT_SERVER=${{ secrets.NEXT_PUBLIC_NEXT_SERVER }}" >> .env.local
            cat .env.local
            echo "ENVFILE: $ENVFILE"
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/meetfolio-web:latest
            sudo docker tag ${{ secrets.DOCKER_USERNAME }}/meetfolio-web:latest meetfolio-web:latest
            sudo docker rm -f meetfolio-web
            sudo docker run -d --name meetfolio-web -e TZ=Asia/Seoul -e PORT=60005 -p 60005:60005 meetfolio-web:latest
            sudo docker cp "$ENVFILE" meetfolio-web:/usr/src/app/.env.local
            sudo docker image prune -af
